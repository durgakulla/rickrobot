<html>
    <head>
    </head>
    <body>
        <!-- Ask for username to display in the chat -->
        <div id="login-wrap" style="width:800;margin: 0 auto;position:relative;top:100px;">
            <form id="login-form" style="display:inline;">
            Enter a display name:<br>
                <input id="name-input" type="text" style="font-size: 14;width:300px;height:50px;border: 2px solid red;border-radius: 4px;" placeholder="Enter your name"></input><br><br>
                <input type="submit" value="Join">
            </form></br></br></br>
        </div>
        <!-- display the canvas and chatbox -->
        <div id="game-wrap" style="font-size: 20;display:none;width:800px;height:600px;margin: 0 auto;">
            <div id="canvas-wrap" style="width: 500px;height: 500px;position: relative;top: 0;right: 0;">
                <canvas id="ctx" width="500" height="500" style="display:inline;"></canvas>
            </div>
            <div id="chat-wrap" style="width:300px;height:500px;position:relative; left:500px; bottom:500px;">
                <div id="chat-text" style="width:100%;height:100%;overflow-y:scroll;display: flex;flex-direction: column-reverse;">
                    <div>Hi! Welcome to the game!</div>
                </div>
                <form id="chat-form" style="display:inline;">
                    <input id="chat-input" type="text" style="font-size: 14;width:300px;height:50px;border: 2px solid red;border-radius: 4px;" placeholder="Type a message..."></input>
                </form>
            </div>
        </div>

        <!-- the following scripts control client game rendering -->
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script>
            //read in form inputs and html/canvas elements
            var loginWrap = document.getElementById("login-wrap");
            var gameWrap = document.getElementById("game-wrap");
            var loginForm = document.getElementById('login-form');
            var nameInput = document.getElementById('name-input');
            var chatText = document.getElementById('chat-text');
            var chatInput = document.getElementById('chat-input');
            var chatForm = document.getElementById('chat-form');
            var ctx = document.getElementById("ctx").getContext("2d");
            //TODO: this is NOT the best way to get roomid. Improve!
            var roomid = window.location.pathname.split('id-').pop();

            //start socket
            var socket = io({transports: ['websocket'], upgrade: false});

            //when a user provides their displayname, send to server
            //also send the server the roomid of the room user is joining
            loginForm.onsubmit = function(e){
                e.preventDefault();
                socket.emit('sendRoomidToServer',roomid);
                socket.emit('sendDisplaynameToServer',[nameInput.value]);
            }

            //Server tells client to showboard after user submits their display name
            socket.on('showBoard',function(){
                loginWrap.style.display = "none";
                gameWrap.style.display = "block";
            });

            //Send a chat message to the server
            chatForm.onsubmit = function(e){
                e.preventDefault();
                if(chatInput.value[0] === '/')
                    socket.emit('evalServer',chatInput.value.slice(1));
                else
                    socket.emit('sendMsgToServer',chatInput.value);
                chatInput.value = '';
            }

            //Server tells client to display a chat message the room received
            socket.on('addToChat',function(data){
                chatText.innerHTML = '<div>' + data + '</div>' + chatText.innerHTML;
            });

            //Tell server a keypress occurred, only if the user isn't using the chat
            document.onkeydown = function(event){
                if(document.activeElement.tagName != 'INPUT'){
                    if(event.keyCode === 39)    //arrow right
                        socket.emit('keyPress',{roomid: roomid, inputId:'right',state:true});
                    else if(event.keyCode === 40)   //arrow down
                        socket.emit('keyPress',{roomid: roomid, inputId:'down',state:true});
                    else if(event.keyCode === 37) //arrow left
                        socket.emit('keyPress',{roomid: roomid, inputId:'left',state:true});
                    else if(event.keyCode === 38) // arrow up
                        socket.emit('keyPress',{roomid: roomid, inputId:'up',state:true});
                    else if(event.keyCode === 49) // 1
                        socket.emit('keyPress',{roomid: roomid, inputId:'one',state:true});
                    else if(event.keyCode === 50) // 2
                        socket.emit('keyPress',{roomid: roomid, inputId:'two',state:true});
                    else if(event.keyCode === 51) // 3
                        socket.emit('keyPress',{roomid: roomid, inputId:'three',state:true});
                    else if(event.keyCode === 52) // 4
                        socket.emit('keyPress',{roomid: roomid, inputId:'four',state:true});
                }
            }
            //Tell server a keypress has ended, only if the user isn't using the chat
            document.onkeyup = function(event){
                if(document.activeElement.tagName != 'INPUT'){
                    if(event.keyCode === 39)    //arrow right
                        socket.emit('keyPress',{roomid: roomid, inputId:'right',state:false});
                    else if(event.keyCode === 40)   //arrow down
                        socket.emit('keyPress',{roomid: roomid, inputId:'down',state:false});
                    else if(event.keyCode === 37) //arrow left
                        socket.emit('keyPress',{roomid: roomid, inputId:'left',state:false});
                    else if(event.keyCode === 38) // arrow up
                        socket.emit('keyPress',{roomid: roomid, inputId:'up',state:false});
                    else if(event.keyCode === 49) // 1
                        socket.emit('keyPress',{roomid: roomid, inputId:'one',state:false});
                    else if(event.keyCode === 50) // 2
                        socket.emit('keyPress',{roomid: roomid, inputId:'two',state:false});
                    else if(event.keyCode === 51) // 3
                        socket.emit('keyPress',{roomid: roomid, inputId:'three',state:false});
                    else if(event.keyCode === 52) // 4
                        socket.emit('keyPress',{roomid: roomid, inputId:'four',state:false});
                }
            }

            socket.on('gameUpdate',function(game){
                game = game[roomid];
                const squareSize = 25;
                //position of board's top left
                const boardTopx = 0;
                const boardTopy = 0;
                //draw each square on the board
                for(let i=0; i<game.board.length; i++) {
                  for(let j=0; j<game.board[0].length; j++) {
                    if(game.board[i][j] === 0)
                      ctx.fillStyle = "white";
                    else if(game.board[i][j] === 1)
                      ctx.fillStyle = "black";
                    else
                      ctx.fillStyle = "white";
                    let xOffset = boardTopx + j*squareSize;
                    let yOffset = boardTopy + i*squareSize;
                    ctx.fillRect(xOffset, yOffset, squareSize, squareSize);
                    ctx.strokeStyle = "black";
                    ctx.strokeRect(xOffset, yOffset, squareSize, squareSize);
                  }
                }
                //draw the border around the board
                ctx.strokeStyle = "black";
                ctx.strokeRect(boardTopx, boardTopy, squareSize*game.board.length, squareSize*game.board.length)
                //draw each game piece
                for(piece in game.piecePositions){
                    let yOffset = boardTopy + game.piecePositions[piece][0]*squareSize;
                    let xOffset = boardTopx + game.piecePositions[piece][1]*squareSize;
                    ctx.fillStyle = piece;
                    ctx.fillRect(xOffset+5/2, yOffset+5/2, squareSize-5, squareSize-5);
                }

            });

        </script>
    </body>
</html>
